<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∞—Ö—Ç—ë—Ä—Å–∫–∞—è –≥–ª—É–±–∏–Ω–∞ 3D</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            z-index: 100;
            pointer-events: none;
        }
        #boss-health {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            z-index: 100;
            display: none;
        }
        .health-bar {
            width: 200px;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }
        .health-fill {
            height: 100%;
            background-color: #f44;
            width: 100%;
            transition: width 0.2s;
        }
        #debug-info {
            position: absolute;
            bottom: 80px;
            left: 10px;
            right: 10px;
            color: white;
            background: rgba(0,0,0,0.9);
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-word;
            border: 2px solid yellow;
        }
        #error-message {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            color: red;
            background: rgba(0,0,0,0.9);
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-word;
            border: 2px solid red;
        }
        #testButton {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 2000;
            background: red;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            pointer-events: auto;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js"
            }
        }
    </script>
</head>
<body>
    <div id="hud">
        <div>üí∞ –ó–æ–ª–æ—Ç–æ: <span id="gold">0</span></div>
        <div>‚ú® –û–ø—ã—Ç: <span id="exp">0</span></div>
        <div>üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å: <span id="inventory">‚Äî</span></div>
    </div>
    <div id="boss-health">
        <div>üëæ –ë–æ—Å—Å: <span id="boss-name"></span></div>
        <div class="health-bar"><div class="health-fill" id="boss-health-fill" style="width:100%"></div></div>
        <div><span id="boss-current-health">0</span>/<span id="boss-max-health">0</span></div>
    </div>
    <div id="debug-info" style="display: none;"></div>
    <div id="error-message" style="display: none;"></div>
    <button id="testButton">–¢–ï–°–¢</button>

    <script type="module">
        // --- –ù–ê–°–¢–†–û–ô–ö–ê: –ê–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –Ω–∞ Render ---
        const API_BASE_URL = 'https://telegram-clicker-bot-zi6c.onrender.com'; // <--- –ò–ó–ú–ï–ù–ò–¢–ï –≠–¢–û!
        // ---------------------------------------------

        // –û—Ç–ª–∞–¥–∫–∞
        function debugLog(msg) {
            const el = document.getElementById('debug-info');
            el.style.display = 'block';
            el.innerHTML = msg;
            console.log(msg);
        }

        function showError(msg) {
            const el = document.getElementById('error-message');
            el.style.display = 'block';
            el.innerHTML = msg;
        }

        // Telegram
        let tg;
        try {
            tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
        } catch (e) {
            tg = { ready: () => {}, expand: () => {}, HapticFeedback: { impactOccurred: () => {} }, initData: "" };
        }
        const initData = tg.initData;
        debugLog('initData: ' + (initData ? initData.substring(0,50) + '...' : '–Ω–µ—Ç'));

        // API
        async function apiCall(endpoint, method = 'GET', body = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (initData) headers['X-Telegram-Init-Data'] = initData;
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);
            try {
                const response = await fetch(`${API_BASE_URL}/api/${endpoint}`, options);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (e) {
                showError(`–û—à–∏–±–∫–∞ API ${endpoint}: ${e.message}`);
                return null;
            }
        }

        // –¢–µ—Å—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞
        document.getElementById('testButton').onclick = async () => {
            showError('–¢–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω...');
            const data = await apiCall('click', 'POST', { resourceId: 0 });
            if (data) {
                showError(`–£—Å–ø–µ—Ö! –ó–æ–ª–æ—Ç–æ: ${data.new_gold}`);
                document.getElementById('gold').textContent = data.new_gold;
                document.getElementById('exp').textContent = data.new_exp;
            }
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUser() {
            const data = await apiCall('user');
            if (!data) return;
            document.getElementById('gold').textContent = data.gold;
            document.getElementById('exp').textContent = data.exp;
            const inv = Object.entries(data.inventory).filter(([,v]) => v>0).map(([k,v]) => `${k}:${v}`).join(', ');
            document.getElementById('inventory').textContent = inv || '–ø—É—Å—Ç–æ';
            if (data.boss_progress) {
                for (let [bid, prog] of Object.entries(data.boss_progress)) {
                    if (!prog.defeated) {
                        document.getElementById('boss-health').style.display = 'block';
                        document.getElementById('boss-name').textContent = bid;
                        loadBossInfo(bid);
                        break;
                    }
                }
            }
        }

        async function loadBossInfo(bid) {
            const data = await apiCall(`boss/${bid}`);
            if (data) {
                document.getElementById('boss-current-health').textContent = data.current_health;
                document.getElementById('boss-max-health').textContent = data.max_health;
                const percent = (data.current_health / data.max_health) * 100;
                document.getElementById('boss-health-fill').style.width = percent + '%';
            }
        }

        // 3D —Å—Ü–µ–Ω–∞
        import('three').then((THREE) => {
            import('https://unpkg.com/three@0.128.0/examples/jsm/controls/OrbitControls.js').then(({ OrbitControls }) => {
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x111122);
                const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
                camera.position.set(8, 6, 12);
                camera.lookAt(0, 1, 0);
                const renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(innerWidth, innerHeight);
                document.body.appendChild(renderer.domElement);
                const controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.maxPolarAngle = Math.PI/2;
                controls.target.set(0, 1, 0);

                // –û—Å–≤–µ—â–µ–Ω–∏–µ
                const ambient = new THREE.AmbientLight(0x404060);
                scene.add(ambient);
                const light1 = new THREE.DirectionalLight(0xffffff, 1);
                light1.position.set(5, 10, 7);
                scene.add(light1);
                const light2 = new THREE.DirectionalLight(0xffaa88, 0.5);
                light2.position.set(-5, 5, -5);
                scene.add(light2);

                // –ü–æ–ª —Å —Å–µ—Ç–∫–æ–π (—á—Ç–æ–±—ã –ª—É—á—à–µ –≤–∏–¥–µ—Ç—å)
                const gridHelper = new THREE.GridHelper(20, 20, 0xaaaaaa, 0x444444);
                gridHelper.position.y = 0;
                scene.add(gridHelper);

                // –ö—É–±—ã-—Ä–µ—Å—É—Ä—Å—ã (–±–æ–ª—å—à–∏–µ –∏ —è—Ä–∫–∏–µ)
                const cubes = [];
                const positions = [
                    [-3, 1.5, -2],
                    [ 3, 1.5, -2],
                    [ 0, 1.5,  2],
                    [-2, 1.5,  3],
                    [ 2, 1.5,  3]
                ];
                positions.forEach((pos, i) => {
                    const geom = new THREE.BoxGeometry(2, 2, 2); // —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä
                    const mat = new THREE.MeshStandardMaterial({ 
                        color: i === 0 ? 0xffaa00 : i === 1 ? 0xcc8800 : i === 2 ? 0xaaaaaa : i === 3 ? 0x44aa88 : 0x8844aa,
                        emissive: 0x222222,
                        roughness: 0.3,
                        metalness: 0.1
                    });
                    const cube = new THREE.Mesh(geom, mat);
                    cube.position.set(pos[0], pos[1], pos[2]);
                    cube.userData = { type: 'resource', id: i };
                    scene.add(cube);
                    cubes.push(cube);
                });

                // –ë–æ—Å—Å
                const bossGeom = new THREE.ConeGeometry(1.5, 3, 8);
                const bossMat = new THREE.MeshStandardMaterial({ color: 0xff3333, emissive: 0x440000 });
                const boss = new THREE.Mesh(bossGeom, bossMat);
                boss.position.set(0, 1.5, 0);
                boss.userData = { type: 'boss' };
                boss.visible = false;
                scene.add(boss);

                // –†—ç–π–∫–∞—Å—Ç–µ—Ä
                const raycaster = new THREE.Raycaster();
                const mouse = new THREE.Vector2();

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–∞—Å–∞–Ω–∏–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
                function onTouchStart(event) {
                    event.preventDefault(); // —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å –µ—â—ë –∏ –∫–ª–∏–∫
                    const touch = event.touches[0];
                    if (!touch) return;
                    const rect = renderer.domElement.getBoundingClientRect();
                    // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º—ã—à–∏ (-1 –¥–æ 1)
                    mouse.x = ((touch.clientX - rect.left) / rect.width) * 2 - 1;
                    mouse.y = -((touch.clientY - rect.top) / rect.height) * 2 + 1;
                    
                    debugLog(`–ö–∞—Å–∞–Ω–∏–µ: screen (${touch.clientX},${touch.clientY}) -> –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–æ (${mouse.x.toFixed(2)}, ${mouse.y.toFixed(2)})`);

                    raycaster.setFromCamera(mouse, camera);
                    const intersects = raycaster.intersectObjects([...cubes, boss]);
                    
                    if (intersects.length > 0) {
                        const hit = intersects[0].object;
                        debugLog(`–ü–æ–ø–∞–ª –≤ –æ–±—ä–µ–∫—Ç: type=${hit.userData.type}, id=${hit.userData.id}, —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ=${intersects[0].distance.toFixed(2)}`);
                        
                        if (hit.userData.type === 'resource') {
                            showError(`–ö–ª–∏–∫ –ø–æ —Ä–µ—Å—É—Ä—Å—É ${hit.userData.id}`);
                            apiCall('click', 'POST', { resourceId: hit.userData.id }).then(data => {
                                if (data) {
                                    document.getElementById('gold').textContent = data.new_gold;
                                    document.getElementById('exp').textContent = data.new_exp;
                                    const inv = Object.entries(data.inventory).filter(([,v]) => v>0).map(([k,v]) => `${k}:${v}`).join(', ');
                                    document.getElementById('inventory').textContent = inv || '–ø—É—Å—Ç–æ';
                                    showError(`+${data.gold}üí∞`);
                                }
                            });
                        } else if (hit.userData.type === 'boss') {
                            showError('–ö–ª–∏–∫ –ø–æ –±–æ—Å—Å—É (—Å–∫–æ—Ä–æ –±—É–¥–µ—Ç)');
                            // –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞—Ç–∞–∫—É –±–æ—Å—Å–∞
                        }
                    } else {
                        debugLog('–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –Ω–µ—Ç');
                        showError('–ú–∏–º–æ');
                    }
                }

                // –î–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º click
                function onClick(event) {
                    const rect = renderer.domElement.getBoundingClientRect();
                    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                    
                    raycaster.setFromCamera(mouse, camera);
                    const intersects = raycaster.intersectObjects([...cubes, boss]);
                    
                    if (intersects.length > 0) {
                        const hit = intersects[0].object;
                        if (hit.userData.type === 'resource') {
                            apiCall('click', 'POST', { resourceId: hit.userData.id }).then(data => {
                                if (data) {
                                    document.getElementById('gold').textContent = data.new_gold;
                                    document.getElementById('exp').textContent = data.new_exp;
                                    const inv = Object.entries(data.inventory).filter(([,v]) => v>0).map(([k,v]) => `${k}:${v}`).join(', ');
                                    document.getElementById('inventory').textContent = inv || '–ø—É—Å—Ç–æ';
                                }
                            });
                        }
                    }
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                renderer.domElement.addEventListener('touchstart', onTouchStart, { passive: false });
                renderer.domElement.addEventListener('click', onClick);

                // –ê–Ω–∏–º–∞—Ü–∏—è
                function animate() {
                    cubes.forEach(c => c.rotation.y += 0.01);
                    if (boss.visible) boss.rotation.y += 0.01;
                    controls.update();
                    renderer.render(scene, camera);
                    requestAnimationFrame(animate);
                }
                animate();

                // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                loadUser();

                window.addEventListener('resize', () => {
                    camera.aspect = innerWidth/innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(innerWidth, innerHeight);
                });
            });
        });
    </script>
</body>
</html>
