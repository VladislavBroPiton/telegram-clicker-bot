<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–®–∞—Ö—Ç—ë—Ä—Å–∫–∞—è –≥–ª—É–±–∏–Ω–∞ 3D</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; touch-action: none; }
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 250px;
            color: white;
            background: rgba(20, 20, 30, 0.85);
            backdrop-filter: blur(4px);
            padding: 12px 16px;
            border-radius: 16px;
            z-index: 200;
            pointer-events: none;
            border: 1px solid rgba(255,215,0,0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            font-size: 14px;
        }
        #exp-bar-container {
            width: 100%;
            height: 8px;
            background-color: #333;
            border-radius: 4px;
            margin: 8px 0 4px 0;
            overflow: hidden;
        }
        #exp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            width: 0%;
            transition: width 0.3s ease;
        }
        #exp-text {
            font-size: 12px;
            color: #aaccff;
            text-align: right;
        }
        #boss-health {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 230px;
            color: white;
            background: rgba(20, 20, 30, 0.85);
            backdrop-filter: blur(4px);
            padding: 12px 16px;
            border-radius: 16px;
            z-index: 150;
            display: none;
            border: 1px solid #ff4444;
            box-shadow: 0 4px 15px rgba(255,0,0,0.2);
            pointer-events: none;
        }
        .health-bar {
            width: 100%;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 8px;
        }
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ff8844);
            width: 100%;
            transition: width 0.2s;
        }
        .boss-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            pointer-events: auto;
        }
        .boss-nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 20px;
            width: 40px;
            height: 40px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }
        .boss-nav-btn:active { background: rgba(255,255,255,0.4); }
        .boss-nav-btn.disabled { opacity: 0.3; pointer-events: none; }

        #debug-info, #error-message, #success-message, #loot-message {
            position: absolute;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            padding: 10px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-word;
            pointer-events: none;
        }
        #debug-info {
            bottom: 80px;
            border: 2px solid yellow;
            color: white;
            max-height: 150px;
            overflow: auto;
        }
        #error-message {
            bottom: 10px;
            border: 2px solid red;
            color: #ff8888;
        }
        #success-message {
            bottom: 60px;
            border: 2px solid #0f0;
            color: #aaffaa;
        }
        #loot-message {
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.95);
            border: 2px solid gold;
            color: gold;
            font-size: 18px;
            text-align: center;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 0 30px gold;
            display: none;
            pointer-events: none;
        }
        #test-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 2000;
            background: #ff4444;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            pointer-events: auto;
        }
        #tool-display {
            margin-top: 8px;
            font-size: 13px;
            color: #ffaa66;
            border-top: 1px solid #444;
            padding-top: 6px;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js"
            }
        }
    </script>
</head>
<body>
    <div id="hud">
        <div style="display: flex; justify-content: space-between;">
            <span>üí∞ <span id="gold">0</span></span>
            <span>‚ú® <span id="exp">0</span></span>
        </div>
        <div id="exp-bar-container"><div id="exp-bar-fill"></div></div>
        <div id="exp-text">–£—Ä–æ–≤–µ–Ω—å <span id="level">1</span> ‚Ä¢ <span id="exp-current">0</span>/100 –æ–ø—ã—Ç–∞</div>
        <div>üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å: <span id="inventory">‚Äî</span></div>
        <div id="tool-display">üß∞ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: <span id="active-tool">–∑–∞–≥—Ä—É–∑–∫–∞...</span></div>
    </div>
    <div id="boss-health">
        <div style="display: flex; justify-content: space-between;">
            <span>üëæ <span id="boss-name"></span></span>
            <span><span id="boss-current-health">0</span>/<span id="boss-max-health">0</span></span>
        </div>
        <div class="health-bar"><div class="health-fill" id="boss-health-fill"></div></div>
        <div class="boss-navigation">
            <button class="boss-nav-btn" id="prev-boss">‚Üê</button>
            <span style="font-size: 14px;" id="boss-index">1/3</span>
            <button class="boss-nav-btn" id="next-boss">‚Üí</button>
        </div>
    </div>
    <div id="debug-info" style="display: none;"></div>
    <div id="error-message" style="display: none;"></div>
    <div id="success-message" style="display: none;"></div>
    <div id="loot-message">üéÅ –ü–û–ë–ï–î–ê!<br><span id="loot-details"></span></div>
    <button id="test-button">–¢–ï–°–¢</button>

    <script type="module">
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const API_BASE_URL = 'https://telegram-clicker-bot-zi6c.onrender.com';
        const EXP_PER_LEVEL = 100; // –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–æ–º

        // –°–ø–∏—Å–æ–∫ –±–æ—Å—Å–æ–≤ –≤ –ø–æ—Ä—è–¥–∫–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (ID –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–Ω—ã–º–∏)
        const BOSS_IDS = ['goblin_king', 'dragon_lair', 'lich_castle'];
        // –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π (–º–æ–∂–Ω–æ –±—Ä–∞—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞, –Ω–æ –ø–æ–∫–∞ —Ö–∞—Ä–¥–∫–æ–¥)
        const BOSS_NAMES = {
            'goblin_king': '–ö–æ—Ä–æ–ª—å –≥–æ–±–ª–∏–Ω–æ–≤',
            'dragon_lair': '–û–≥–Ω–µ–Ω–Ω—ã–π –¥—Ä–∞–∫–æ–Ω',
            'lich_castle': '–ê—Ä—Ö–∏–ª–∏—á'
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentBossIndex = 0; // –∏–Ω–¥–µ–∫—Å –≤ BOSS_IDS
        let currentBossId = BOSS_IDS[0];
        let isAttacking = false;
        let bossMesh = null;
        let cubes = [];
        let scene, camera, renderer, controls;
        let particleSystem = null; // –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ —É–¥–∞—Ä–∞

        // –ê—É–¥–∏–æ (—Å–æ–∑–¥–∞–¥–∏–º –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞)
        let audioClick = new Audio('https://github.com/VladislavBroPiton/telegram-clicker-bot/blob/main/creatorshome-pickaxe-blow-333695.mp3'); // –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–∏
        let audioBossHit = new Audio('https://github.com/VladislavBroPiton/telegram-clicker-bot/blob/main/creatorshome-pickaxe-blow-333695.mp3');
        let audioVictory = new Audio('https://github.com/VladislavBroPiton/telegram-clicker-bot/blob/main/creatorshome-pickaxe-blow-333695.mp3');
        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∏–º
        audioClick.load();
        audioBossHit.load();
        audioVictory.load();

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const hudLevel = document.getElementById('level');
        const hudExp = document.getElementById('exp');
        const hudExpCurrent = document.getElementById('exp-current');
        const expBarFill = document.getElementById('exp-bar-fill');
        const goldSpan = document.getElementById('gold');
        const inventorySpan = document.getElementById('inventory');
        const activeToolSpan = document.getElementById('active-tool');
        const bossHealthDiv = document.getElementById('boss-health');
        const bossNameSpan = document.getElementById('boss-name');
        const bossCurrentHealth = document.getElementById('boss-current-health');
        const bossMaxHealth = document.getElementById('boss-max-health');
        const bossHealthFill = document.getElementById('boss-health-fill');
        const bossIndexSpan = document.getElementById('boss-index');
        const debugInfo = document.getElementById('debug-info');
        const errorMsg = document.getElementById('error-message');
        const successMsg = document.getElementById('success-message');
        const lootMsg = document.getElementById('loot-message');
        const lootDetails = document.getElementById('loot-details');

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        function debugLog(msg) {
            debugInfo.style.display = 'block';
            debugInfo.innerHTML = msg + '<br>' + debugInfo.innerHTML;
            console.log(msg);
        }

        function showError(msg) {
            errorMsg.style.display = 'block';
            errorMsg.innerHTML = msg;
        }

        function showSuccess(msg) {
            successMsg.style.display = 'block';
            successMsg.innerHTML = msg;
            setTimeout(() => successMsg.style.display = 'none', 2000);
        }

        function showLoot(items) {
            lootDetails.innerHTML = items;
            lootMsg.style.display = 'block';
            setTimeout(() => lootMsg.style.display = 'none', 4000);
        }

        // --- –¢–ï–õ–ï–ì–†–ê–ú ---
        let tg;
        try {
            tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
        } catch (e) {
            tg = { ready: () => {}, expand: () => {}, HapticFeedback: { impactOccurred: () => {} }, initData: "" };
        }
        const initData = tg.initData;
        debugLog('initData: ' + (initData ? initData.substring(0,50) + '...' : '–Ω–µ—Ç'));

        // --- API –° –£–õ–£–ß–®–ï–ù–ù–û–ô –û–¢–õ–ê–î–ö–û–ô ---
        async function apiCall(endpoint, method = 'GET', body = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (initData) headers['X-Telegram-Init-Data'] = initData;
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);

            debugLog(`‚û°Ô∏è –ó–∞–ø—Ä–æ—Å ${method} /api/${endpoint} ` + (body ? `—Ç–µ–ª–æ: ${JSON.stringify(body)}` : ''));

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                options.signal = controller.signal;

                const response = await fetch(`${API_BASE_URL}/api/${endpoint}`, options);
                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0,100)}`);
                }
                const json = await response.json();
                debugLog(`‚úÖ –û—Ç–≤–µ—Ç –æ—Ç ${endpoint}: ${JSON.stringify(json, null, 2)}`);
                return json;
            } catch (e) {
                const errorMsg = `‚ùå –û—à–∏–±–∫–∞ API ${endpoint}: ${e.message}`;
                debugLog(errorMsg);
                showError(errorMsg);
                return null;
            }
        }

        // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
        function updateExpBar(level, exp) {
            hudLevel.textContent = level;
            hudExp.textContent = exp;
            hudExpCurrent.textContent = exp;
            const percent = (exp / EXP_PER_LEVEL) * 100;
            expBarFill.style.width = percent + '%';
        }

        function updateInventoryDisplay(inv) {
            if (!inv) {
                inventorySpan.textContent = '‚Äî';
                return;
            }
            const entries = Object.entries(inv).filter(([,v]) => v > 0);
            if (entries.length === 0) inventorySpan.textContent = '–ø—É—Å—Ç–æ';
            else inventorySpan.textContent = entries.map(([k,v]) => `${k}:${v}`).join(', ');
        }

        function updateBossHealth(current, max) {
            bossCurrentHealth.textContent = current;
            bossMaxHealth.textContent = max;
            const percent = max > 0 ? (current / max) * 100 : 0;
            bossHealthFill.style.width = percent + '%';
        }

        // --- –ó–ê–ì–†–£–ó–ö–ê –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï ---
        async function loadUser() {
            const data = await apiCall('user');
            if (!data) return;

            goldSpan.textContent = data.gold;
            updateExpBar(data.level, data.exp);
            updateInventoryDisplay(data.inventory);
            if (data.active_tool) {
                activeToolSpan.textContent = data.active_tool; // –æ–∂–∏–¥–∞–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—ë—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ
            } else {
                activeToolSpan.textContent = '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Å—Å–æ–≤
            if (data.boss_progress) {
                // –ù–∞–π–¥—ë–º –ø–µ—Ä–≤–æ–≥–æ –Ω–µ–ø–æ–±–µ–∂–¥—ë–Ω–Ω–æ–≥–æ
                let found = false;
                for (let i = 0; i < BOSS_IDS.length; i++) {
                    const bid = BOSS_IDS[i];
                    const prog = data.boss_progress[bid];
                    if (prog && !prog.defeated) {
                        currentBossIndex = i;
                        currentBossId = bid;
                        found = true;
                        break;
                    }
                }
                if (!found && BOSS_IDS.length > 0) {
                    // –≤—Å–µ –ø–æ–±–µ–∂–¥–µ–Ω—ã ‚Äì –ø–æ–∫–∞–∂–µ–º –ø–µ—Ä–≤–æ–≥–æ
                    currentBossIndex = 0;
                    currentBossId = BOSS_IDS[0];
                }
                loadBossInfo(currentBossId);
            }
        }

        // --- –ó–ê–ì–†–£–ó–ö–ê –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –ë–û–°–°–ï ---
        async function loadBossInfo(bid) {
            const data = await apiCall(`boss/${bid}`);
            if (data) {
                bossNameSpan.textContent = BOSS_NAMES[bid] || bid;
                updateBossHealth(data.current_health, data.max_health);
                bossHealthDiv.style.display = 'block';
                if (bossMesh) bossMesh.visible = true;
                updateBossNavigation();
            }
        }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø –ü–û –ë–û–°–°–ê–ú ---
        function updateBossNavigation() {
            bossIndexSpan.textContent = `${currentBossIndex+1}/${BOSS_IDS.length}`;
            document.getElementById('prev-boss').classList.toggle('disabled', currentBossIndex === 0);
            document.getElementById('next-boss').classList.toggle('disabled', currentBossIndex === BOSS_IDS.length-1);
        }

        document.getElementById('prev-boss').addEventListener('click', () => {
            if (currentBossIndex > 0) {
                currentBossIndex--;
                currentBossId = BOSS_IDS[currentBossIndex];
                loadBossInfo(currentBossId);
            }
        });
        document.getElementById('next-boss').addEventListener('click', () => {
            if (currentBossIndex < BOSS_IDS.length-1) {
                currentBossIndex++;
                currentBossId = BOSS_IDS[currentBossIndex];
                loadBossInfo(currentBossId);
            }
        });

        // --- –ß–ê–°–¢–ò–¶–´ –ü–†–ò –£–î–ê–†–ï ---
        function createHitParticles(position) {
            if (!scene) return;
            const particleCount = 15;
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            for (let i = 0; i < particleCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 0.2 + Math.random() * 0.3;
                positions[i*3] = position.x;
                positions[i*3+1] = position.y;
                positions[i*3+2] = position.z;
                // —Ü–≤–µ—Ç–∞: –∫—Ä–∞—Å–Ω—ã–µ/–æ—Ä–∞–Ω–∂–µ–≤—ã–µ
                colors[i*3] = 1;
                colors[i*3+1] = 0.3 + Math.random()*0.3;
                colors[i*3+2] = 0.1;
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({ size: 0.2, vertexColors: true, transparent: true });
            const particles = new THREE.Points(geometry, material);
            scene.add(particles);

            // –ê–Ω–∏–º–∞—Ü–∏—è —Ä–∞–∑–ª—ë—Ç–∞
            const startTime = performance.now();
            function animateParticles() {
                const elapsed = performance.now() - startTime;
                if (elapsed > 500) {
                    scene.remove(particles);
                    return;
                }
                const positionsAttr = geometry.attributes.position;
                for (let i = 0; i < particleCount; i++) {
                    const angle = Math.random() * Math.PI * 2; // —É–ø—Ä–æ—â—ë–Ω–Ω–æ, –Ω–æ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ —Å–æ–π–¥—ë—Ç
                    positionsAttr.array[i*3] += Math.cos(angle) * 0.05;
                    positionsAttr.array[i*3+1] += Math.sin(angle) * 0.05;
                    positionsAttr.array[i*3+2] += (Math.random() - 0.5) * 0.05;
                }
                positionsAttr.needsUpdate = true;
                requestAnimationFrame(animateParticles);
            }
            animateParticles();
        }

        // --- –ê–¢–ê–ö–ê –ù–ê –ë–û–°–°–ê ---
        async function attackBoss() {
            if (isAttacking) return;
            if (!currentBossId) {
                showError('–ë–æ—Å—Å –Ω–µ –≤—ã–±—Ä–∞–Ω');
                return;
            }

            isAttacking = true;
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç: –≤—Å–ø—ã—à–∫–∞
            if (bossMesh) {
                bossMesh.material.emissive.setHex(0xaa0000);
                setTimeout(() => bossMesh.material.emissive.setHex(0x440000), 150);
            }
            // –ó–≤—É–∫ —É–¥–∞—Ä–∞
            audioBossHit.currentTime = 0;
            audioBossHit.play().catch(() => {}); // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞

            try {
                const data = await apiCall('boss/attack', 'POST', { boss_id: currentBossId });
                if (!data) return;

                if (data.error) {
                    showError(data.error);
                    return;
                }

                // –£—Å–ø–µ—Ö ‚Äì –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ—Å—É—Ä—Å—ã
                if (data.new_gold !== undefined) goldSpan.textContent = data.new_gold;
                if (data.new_exp !== undefined) {
                    hudExp.textContent = data.new_exp;
                    // –Ω—É–∂–Ω–æ —Ç–∞–∫–∂–µ –ø–æ–ª—É—á–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å, –Ω–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç; –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    // –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏–º –æ–ø—ã—Ç, –∞ —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥—Ç—è–Ω–µ–º –ø–æ–∑–∂–µ
                }
                if (data.inventory) updateInventoryDisplay(data.inventory);

                // –ó–¥–æ—Ä–æ–≤—å–µ –±–æ—Å—Å–∞
                if (data.current_health !== undefined && data.max_health !== undefined) {
                    updateBossHealth(data.current_health, data.max_health);
                    createHitParticles(bossMesh.position.clone()); // —á–∞—Å—Ç–∏—Ü—ã
                }

                // –ï—Å–ª–∏ –±–æ—Å—Å –ø–æ–±–µ–∂–¥—ë–Ω
                if (data.defeated) {
                    audioVictory.currentTime = 0;
                    audioVictory.play().catch(() => {});
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª—É—Ç (–µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª —Å–ø–∏—Å–æ–∫ –≤—ã–ø–∞–≤—à–µ–≥–æ)
                    if (data.loot) {
                        showLoot(data.loot);
                    } else {
                        showLoot('–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞!');
                    }
                    // –°–∫—Ä—ã–≤–∞–µ–º –±–æ—Å—Å–∞ –∏–ª–∏ –±–ª–æ–∫–∏—Ä—É–µ–º –∞—Ç–∞–∫—É
                    bossMesh.visible = false;
                    bossHealthDiv.style.display = 'none';
                } else {
                    showSuccess('–£–¥–∞—Ä!');
                }

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∏ –æ–ø—ã—Ç
                loadUser();
            } catch (e) {
                console.error(e);
            } finally {
                isAttacking = false;
            }
        }

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø 3D ---
        async function init3D() {
            const THREE = await import('three');
            const { OrbitControls } = await import('https://unpkg.com/three@0.128.0/examples/jsm/controls/OrbitControls.js');

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111122);

            camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
            camera.position.set(8, 6, 12);
            camera.lookAt(0, 1, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(innerWidth, innerHeight);
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.maxPolarAngle = Math.PI/2;
            controls.target.set(0, 1, 0);

            // –û—Å–≤–µ—â–µ–Ω–∏–µ
            const ambient = new THREE.AmbientLight(0x404060);
            scene.add(ambient);
            const light1 = new THREE.DirectionalLight(0xffffff, 1);
            light1.position.set(5, 10, 7);
            scene.add(light1);
            const light2 = new THREE.DirectionalLight(0xffaa88, 0.5);
            light2.position.set(-5, 5, -5);
            scene.add(light2);

            // –ü–æ–ª
            const gridHelper = new THREE.GridHelper(20, 20, 0xaaaaaa, 0x444444);
            gridHelper.position.y = 0;
            scene.add(gridHelper);

            // –ö—É–±—ã-—Ä–µ—Å—É—Ä—Å—ã
            const positions = [
                [-3, 1.5, -2],
                [ 3, 1.5, -2],
                [ 0, 1.5,  2],
                [-2, 1.5,  3],
                [ 2, 1.5,  3]
            ];
            positions.forEach((pos, i) => {
                const geom = new THREE.BoxGeometry(2, 2, 2);
                const mat = new THREE.MeshStandardMaterial({ 
                    color: i === 0 ? 0xffaa00 : i === 1 ? 0xcc8800 : i === 2 ? 0xaaaaaa : i === 3 ? 0x44aa88 : 0x8844aa,
                    emissive: 0x222222,
                    roughness: 0.3,
                    metalness: 0.1
                });
                const cube = new THREE.Mesh(geom, mat);
                cube.position.set(pos[0], pos[1], pos[2]);
                cube.userData = { type: 'resource', id: i };
                scene.add(cube);
                cubes.push(cube);
            });

            // –ë–æ—Å—Å
            const bossGeom = new THREE.ConeGeometry(1.5, 3, 8);
            const bossMat = new THREE.MeshStandardMaterial({ color: 0xff3333, emissive: 0x440000 });
            const boss = new THREE.Mesh(bossGeom, bossMat);
            boss.position.set(0, 1.5, 0);
            boss.userData = { type: 'boss' };
            boss.visible = false;
            scene.add(boss);
            bossMesh = boss;

            // –†—ç–π–∫–∞—Å—Ç–µ—Ä
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();

            function onTouchStart(event) {
                event.preventDefault();
                const touch = event.touches[0];
                if (!touch) return;
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((touch.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((touch.clientY - rect.top) / rect.height) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects([...cubes, bossMesh]);

                if (intersects.length > 0) {
                    const hit = intersects[0].object;
                    if (hit.userData.type === 'resource') {
                        audioClick.currentTime = 0;
                        audioClick.play().catch(() => {});
                        apiCall('click', 'POST', { resourceId: hit.userData.id }).then(data => {
                            if (data) {
                                goldSpan.textContent = data.new_gold;
                                hudExp.textContent = data.new_exp;
                                updateInventoryDisplay(data.inventory);
                                showSuccess(`+${data.gold}üí∞`);
                                // –æ–±–Ω–æ–≤–∏–º —É—Ä–æ–≤–µ–Ω—å/–æ–ø—ã—Ç
                                loadUser();
                            }
                        });
                    } else if (hit.userData.type === 'boss') {
                        attackBoss();
                    }
                }
            }

            function onClick(event) {
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects([...cubes, bossMesh]);

                if (intersects.length > 0) {
                    const hit = intersects[0].object;
                    if (hit.userData.type === 'resource') {
                        audioClick.currentTime = 0;
                        audioClick.play().catch(() => {});
                        apiCall('click', 'POST', { resourceId: hit.userData.id }).then(data => {
                            if (data) {
                                goldSpan.textContent = data.new_gold;
                                hudExp.textContent = data.new_exp;
                                updateInventoryDisplay(data.inventory);
                                showSuccess(`+${data.gold}üí∞`);
                                loadUser();
                            }
                        });
                    } else if (hit.userData.type === 'boss') {
                        attackBoss();
                    }
                }
            }

            renderer.domElement.addEventListener('touchstart', onTouchStart, { passive: false });
            renderer.domElement.addEventListener('click', onClick);

            // –ê–Ω–∏–º–∞—Ü–∏—è
            function animate() {
                cubes.forEach(c => c.rotation.y += 0.01);
                if (bossMesh && bossMesh.visible) bossMesh.rotation.y += 0.01;
                controls.update();
                renderer.render(scene, camera);
                requestAnimationFrame(animate);
            }
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = innerWidth/innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(innerWidth, innerHeight);
            });
        }

        // --- –°–¢–ê–†–¢ ---
        document.getElementById('test-button').addEventListener('click', () => {
            apiCall('click', 'POST', { resourceId: 0 }).then(data => {
                if (data) {
                    goldSpan.textContent = data.new_gold;
                    hudExp.textContent = data.new_exp;
                    updateInventoryDisplay(data.inventory);
                    loadUser();
                }
            });
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        init3D();
        loadUser();
    </script>
</body>
</html>

