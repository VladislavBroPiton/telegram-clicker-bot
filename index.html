<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –≤–∏–¥–∏–º–æ—Å—Ç–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        #hud, #boss-health {
            position: absolute;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            z-index: 200;
        }
        #hud { top: 10px; left: 10px; }
        #boss-health { top: 10px; right: 10px; display: none; }
        #debug-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: black;
            color: #0f0;
            padding: 10px;
            max-height: 200px;
            overflow: auto;
            z-index: 1000;
        }
    </style>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.128.0/build/three.module.js" } }
    </script>
</head>
<body>
    <div id="hud">üí∞ <span id="gold">0</span> ‚ú® <span id="exp">0</span><br>–£—Ä–æ–≤–µ–Ω—å <span id="level">1</span></div>
    <div id="boss-health"><span id="boss-name"></span> <span id="boss-current-health">0</span>/<span id="boss-max-health">0</span></div>
    <div id="debug-info"></div>

    <script type="module">
        const API_BASE_URL = 'https://telegram-clicker-bot-zi6c.onrender.com';
        const BOSS_IDS = ['goblin_king', 'dragon_lair', 'lich_castle'];
        const BOSS_NAMES = {
            'goblin_king': '–ö–æ—Ä–æ–ª—å –≥–æ–±–ª–∏–Ω–æ–≤',
            'dragon_lair': '–û–≥–Ω–µ–Ω–Ω—ã–π –¥—Ä–∞–∫–æ–Ω',
            'lich_castle': '–ê—Ä—Ö–∏–ª–∏—á'
        };
        let currentBossId = BOSS_IDS[0];
        let scene, camera, renderer, controls;
        let bossGroup = null;
        let THREE;

        const debugInfo = document.getElementById('debug-info');
        function debugLog(msg) {
            debugInfo.innerHTML += new Date().toLocaleTimeString() + ': ' + msg + '<br>';
            console.log(msg);
        }

        // --- –¢–ï–õ–ï–ì–†–ê–ú ---
        let tg;
        try { tg = window.Telegram.WebApp; tg.ready(); tg.expand(); } catch (e) { tg = { initData: '' }; }
        const initData = tg.initData;
        debugLog('initData: ' + (initData ? initData.substring(0,50) + '...' : '–Ω–µ—Ç'));

        // --- API (—É–ø—Ä–æ—â—ë–Ω–Ω–æ) ---
        async function apiCall(endpoint) {
            const headers = { 'Content-Type': 'application/json' };
            if (initData) headers['X-Telegram-Init-Data'] = initData;
            try {
                const res = await fetch(`${API_BASE_URL}/api/${endpoint}`, { headers });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            } catch (e) {
                debugLog(`–û—à–∏–±–∫–∞ API: ${e.message}`);
                return null;
            }
        }

        // --- –ú–û–î–ï–õ–¨ –ë–û–°–°–ê (–∂—ë–ª—Ç—ã–π –∫—É–±) ---
        function createBossModel() {
            debugLog('createBossModel');
            if (!THREE) return new THREE.Group();
            const group = new THREE.Group();
            const geom = new THREE.BoxGeometry(3, 3, 3);
            const mat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
            const cube = new THREE.Mesh(geom, mat);
            group.add(cube);
            debugLog('üü° –ñ—ë–ª—Ç—ã–π –∫—É–± —Å–æ–∑–¥–∞–Ω');
            return group;
        }

        async function init3D() {
            debugLog('init3D started');
            const THREE_IMPORT = await import('three');
            THREE = THREE_IMPORT;
            const { OrbitControls } = await import('https://unpkg.com/three@0.128.0/examples/jsm/controls/OrbitControls.js');

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111122);

            camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);
            camera.lookAt(0, 4, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(innerWidth, innerHeight);
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.set(0, 4, 0);
            controls.update();
            debugLog('–ö–∞–º–µ—Ä–∞ –Ω–∞ (0,5,10) —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ (0,4,0)');

            // –û—Å–≤–µ—â–µ–Ω–∏–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ BasicMaterial)
            const ambient = new THREE.AmbientLight(0x404060);
            scene.add(ambient);
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(1, 1, 1);
            scene.add(light);

            // –ü–æ–ª
            const gridHelper = new THREE.GridHelper(20, 20, 0xaaaaaa, 0x444444);
            scene.add(gridHelper);

            // –ö–†–ê–°–ù–´–ô –ö–£–ë (—Ç–µ—Å—Ç–æ–≤—ã–π)
            const redCube = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), new THREE.MeshBasicMaterial({ color: 0xff0000 }));
            redCube.position.set(0, 4, 0);
            scene.add(redCube);
            debugLog('üî¥ –ö—Ä–∞—Å–Ω—ã–π –∫—É–± –≤ (0,4,0)');

            // –°–ï–†–ï–ë–†–ò–°–¢–ê–Ø –°–§–ï–†–ê (–¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –ø–æ–∑–∏—Ü–∏–∏)
            const sphereGeom = new THREE.SphereGeometry(0.5);
            const sphereMat = new THREE.MeshStandardMaterial({ color: 0xcccccc, emissive: 0x333333 });
            const sphere = new THREE.Mesh(sphereGeom, sphereMat);
            sphere.position.set(0, 4, 0);
            scene.add(sphere);
            debugLog('‚ö™ –°–µ—Ä–µ–±—Ä–∏—Å—Ç–∞—è —Å—Ñ–µ—Ä–∞ –≤ (0,4,0)');

            // –ì–†–£–ü–ü–ê –ë–û–°–°–ê
            bossGroup = new THREE.Group();
            scene.add(bossGroup);

            const bossModel = createBossModel();
            bossGroup.add(bossModel);
            debugLog(`–ú–æ–¥–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∞, –¥–µ—Ç–µ–π: ${bossGroup.children.length}`);

            bossGroup.position.set(0, 4, 0);
            debugLog(`bossGroup –ø–æ–∑–∏—Ü–∏—è: (${bossGroup.position.x}, ${bossGroup.position.y}, ${bossGroup.position.z})`);

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Å—Å–∞ –¥–ª—è HUD
            const data = await apiCall('boss/goblin_king');
            if (data) {
                document.getElementById('boss-name').textContent = BOSS_NAMES['goblin_king'];
                document.getElementById('boss-current-health').textContent = data.current_health;
                document.getElementById('boss-max-health').textContent = data.max_health;
                document.getElementById('boss-health').style.display = 'block';
            }

            // –ê–Ω–∏–º–∞—Ü–∏—è
            function animate() {
                if (bossGroup) bossGroup.rotation.y += 0.01;
                redCube.rotation.y += 0.01;
                sphere.rotation.y += 0.01;
                controls.update();
                renderer.render(scene, camera);
                requestAnimationFrame(animate);
            }
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = innerWidth/innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(innerWidth, innerHeight);
            });
        }

        init3D();
    </script>
</body>
</html>
