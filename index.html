<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–µ—Å—Ç –≤–∏–¥–∏–º–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        #hud, #boss-health {
            position: absolute;
            color: white;
            background: rgba(20,20,30,0.85);
            padding: 10px;
            border-radius: 8px;
            z-index: 200;
            pointer-events: none;
        }
        #hud { top: 10px; left: 10px; }
        #boss-health { top: 10px; right: 10px; width: 220px; display: none; }
        #debug-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: black;
            color: #0f0;
            padding: 10px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 12px;
            max-height: 200px;
            overflow: auto;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js"
            }
        }
    </script>
</head>
<body>
    <div id="hud">
        <span>üí∞ <span id="gold">0</span> ‚ú® <span id="exp">0</span></span><br>
        –£—Ä–æ–≤–µ–Ω—å <span id="level">1</span>
    </div>
    <div id="boss-health">
        <span id="boss-name"></span> <span id="boss-current-health">0</span>/<span id="boss-max-health">0</span>
    </div>
    <div id="debug-info"></div>

    <script type="module">
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const API_BASE_URL = 'https://telegram-clicker-bot-zi6c.onrender.com';
        const BOSS_IDS = ['goblin_king', 'dragon_lair', 'lich_castle'];
        const BOSS_NAMES = {
            'goblin_king': '–ö–æ—Ä–æ–ª—å –≥–æ–±–ª–∏–Ω–æ–≤',
            'dragon_lair': '–û–≥–Ω–µ–Ω–Ω—ã–π –¥—Ä–∞–∫–æ–Ω',
            'lich_castle': '–ê—Ä—Ö–∏–ª–∏—á'
        };

        let currentBossIndex = 0;
        let currentBossId = BOSS_IDS[0];
        let scene, camera, renderer, controls;
        let bossGroup = null;
        let THREE;

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const debugInfo = document.getElementById('debug-info');
        function debugLog(msg) {
            debugInfo.innerHTML += new Date().toLocaleTimeString() + ': ' + msg + '<br>';
            console.log(msg);
        }

        // --- –¢–ï–õ–ï–ì–†–ê–ú –ò API (—Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ) ---
        let tg;
        try {
            tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
        } catch (e) {
            tg = { initData: '' };
        }
        const initData = tg.initData;
        debugLog('initData: ' + (initData ? initData.substring(0,50) + '...' : '–Ω–µ—Ç'));

        async function apiCall(endpoint) {
            const headers = { 'Content-Type': 'application/json' };
            if (initData) headers['X-Telegram-Init-Data'] = initData;
            try {
                const res = await fetch(`${API_BASE_URL}/api/${endpoint}`, { headers });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            } catch (e) {
                debugLog(`–û—à–∏–±–∫–∞ API: ${e.message}`);
                return null;
            }
        }

        // --- –ú–û–î–ï–õ–¨ –ë–û–°–°–ê (—è—Ä–∫–∞—è) ---
        function createBossModel(bossId) {
            debugLog(`createBossModel for ${bossId}`);
            if (!THREE) return new THREE.Group();
            try {
                const group = new THREE.Group();
                const geom = new THREE.ConeGeometry(1.5, 3, 16);
                const mat = new THREE.MeshStandardMaterial({ 
                    color: bossId === 'goblin_king' ? 0xffaa00 :
                           bossId === 'dragon_lair' ? 0xff3333 : 0xaa44ff,
                    emissive: 0x222222
                });
                const cone = new THREE.Mesh(geom, mat);
                cone.position.y = 1.5;
                group.add(cone);

                // –í–µ—Ä—Ö–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç
                let top;
                if (bossId === 'goblin_king') {
                    top = new THREE.Mesh(new THREE.BoxGeometry(0.8,0.8,0.8), new THREE.MeshStandardMaterial({ color: 0xffaa00, emissive: 0x442200 }));
                    top.position.y = 3.0;
                } else if (bossId === 'dragon_lair') {
                    top = new THREE.Mesh(new THREE.ConeGeometry(0.7,1.2,8), new THREE.MeshStandardMaterial({ color: 0xff0000, emissive: 0x330000 }));
                    top.position.y = 3.0;
                } else {
                    top = new THREE.Mesh(new THREE.SphereGeometry(0.7), new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0x444444 }));
                    top.position.y = 3.0;
                }
                group.add(top);

                // –ì–ª–∞–∑–∞
                const eyeGeom = new THREE.SphereGeometry(0.2);
                const eyeMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
                const pupilGeom = new THREE.SphereGeometry(0.1);
                const pupilMat = new THREE.MeshStandardMaterial({ color: 0x000000 });
                
                const eyeL = new THREE.Mesh(eyeGeom, eyeMat);
                eyeL.position.set(-0.5, 2.2, 1.2);
                group.add(eyeL);
                const pupilL = new THREE.Mesh(pupilGeom, pupilMat);
                pupilL.position.set(-0.5, 2.2, 1.4);
                group.add(pupilL);
                
                const eyeR = new THREE.Mesh(eyeGeom, eyeMat);
                eyeR.position.set(0.5, 2.2, 1.2);
                group.add(eyeR);
                const pupilR = new THREE.Mesh(pupilGeom, pupilMat);
                pupilR.position.set(0.5, 2.2, 1.4);
                group.add(pupilR);

                group.scale.set(0.8, 0.8, 0.8);
                group.position.y = 1.5;
                debugLog('–ú–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞');
                return group;
            } catch (e) {
                debugLog(`–û—à–∏–±–∫–∞: ${e.message}`);
                return new THREE.Group();
            }
        }

        // --- –ó–ê–ì–†–£–ó–ö–ê –ë–û–°–°–ê ---
        async function loadBossInfo(bid) {
            debugLog(`loadBossInfo for ${bid}`);
            const data = await apiCall(`boss/${bid}`);
            if (data) {
                document.getElementById('boss-name').textContent = BOSS_NAMES[bid] || bid;
                document.getElementById('boss-current-health').textContent = data.current_health;
                document.getElementById('boss-max-health').textContent = data.max_health;
                document.getElementById('boss-health').style.display = 'block';
            }
        }

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø 3D ---
        async function init3D() {
            debugLog('init3D started');
            const THREE_IMPORT = await import('three');
            THREE = THREE_IMPORT;
            const { OrbitControls } = await import('https://unpkg.com/three@0.128.0/examples/jsm/controls/OrbitControls.js');

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111122);

            camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
            camera.position.set(3, 3, 5); // –±–ª–∏–∂–µ –∫ —Ü–µ–Ω—Ç—Ä—É
            camera.lookAt(0, 3, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(innerWidth, innerHeight);
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.set(0, 3, 0);

            // –û—Å–≤–µ—â–µ–Ω–∏–µ
            const ambient = new THREE.AmbientLight(0x404060);
            scene.add(ambient);
            const light1 = new THREE.DirectionalLight(0xffffff, 1);
            light1.position.set(2, 5, 3);
            scene.add(light1);
            const light2 = new THREE.DirectionalLight(0xffaa88, 0.5);
            light2.position.set(-2, 3, -2);
            scene.add(light2);

            // –ü–æ–ª-—Å–µ—Ç–∫–∞
            const gridHelper = new THREE.GridHelper(10, 10, 0xaaaaaa, 0x444444);
            scene.add(gridHelper);

            // –û—Å–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–¥–ª—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–∞)
            const axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);

            // –Ø–†–ö–ê–Ø –ñ–Å–õ–¢–ê–Ø –°–§–ï–†–ê –≤ —Ü–µ–Ω—Ç—Ä–µ, –≥–¥–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–æ–¥–µ–ª—å
            const sphereGeom = new THREE.SphereGeometry(0.5);
            const sphereMat = new THREE.MeshStandardMaterial({ color: 0xffff00, emissive: 0x442200 });
            const sphere = new THREE.Mesh(sphereGeom, sphereMat);
            sphere.position.set(0, 3, 0); // —Ü–µ–Ω—Ç—Ä –º–æ–¥–µ–ª–∏ –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ y=3
            scene.add(sphere);
            debugLog('–ñ—ë–ª—Ç–∞—è —Å—Ñ–µ—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ (0,3,0)');

            // –ì—Ä—É–ø–ø–∞ –¥–ª—è –±–æ—Å—Å–∞
            bossGroup = new THREE.Group();
            scene.add(bossGroup);

            // –°–æ–∑–¥–∞—ë–º –º–æ–¥–µ–ª—å –±–æ—Å—Å–∞
            const bossModel = createBossModel('goblin_king');
            bossGroup.add(bossModel);
            debugLog(`–ú–æ–¥–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∞, –¥–µ—Ç–µ–π: ${bossGroup.children.length}`);

            // –ê–Ω–∏–º–∞—Ü–∏—è
            function animate() {
                if (bossGroup) bossGroup.rotation.y += 0.01;
                sphere.rotation.y += 0.01;
                controls.update();
                renderer.render(scene, camera);
                requestAnimationFrame(animate);
            }
            animate();

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Å—Å–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ HUD
            loadBossInfo('goblin_king');
        }

        init3D();
    </script>
</body>
</html>
