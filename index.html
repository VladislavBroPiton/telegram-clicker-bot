<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∞—Ö—Ç—ë—Ä—Å–∫–∞—è –≥–ª—É–±–∏–Ω–∞ 3D</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            z-index: 100;
            pointer-events: none;
        }
        #boss-health {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            z-index: 100;
            display: none;
        }
    <div id="debug" style="position: absolute; bottom: 10px; left: 10px; color: lime; background: black; padding: 5px; font-size: 12px; z-index: 300; max-width: 90%; word-break: break-all;"></div>
        .health-bar {
            width: 200px;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }
        .health-fill {
            height: 100%;
            background-color: #f44;
            width: 100%;
            transition: width 0.2s;
        }
        #error-message {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: red;
            background: rgba(0,0,0,0.8);
            padding: 5px;
            border-radius: 5px;
            z-index: 200;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div id="hud">
        <div>üí∞ –ó–æ–ª–æ—Ç–æ: <span id="gold">0</span></div>
        <div>‚ú® –û–ø—ã—Ç: <span id="exp">0</span></div>
        <div>üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å: <span id="inventory">‚Äî</span></div>
    </div>
    <div id="boss-health">
        <div>üëæ –ë–æ—Å—Å: <span id="boss-name"></span></div>
        <div class="health-bar"><div class="health-fill" id="boss-health-fill" style="width:100%"></div></div>
        <div><span id="boss-current-health">0</span>/<span id="boss-max-health">0</span></div>
    </div>
    <div id="error-message"></div>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'https://unpkg.com/three@0.128.0/examples/jsm/controls/OrbitControls.js';

        // --- –ù–ê–°–¢–†–û–ô–ö–ê: –ê–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –Ω–∞ Render ---
        const API_BASE_URL = 'https://telegram-clicker-bot-zi6c.onrender.com'; // <--- –ò–ó–ú–ï–ù–ò–¢–ï –≠–¢–û!
        // ---------------------------------------------

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –ø—Ä—è–º–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        function showError(message) {
            const el = document.getElementById('error-message');
            el.textContent += message + '\n';
            console.error(message);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
        let tg;
        try {
            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                console.log("Telegram WebApp initialized");
            } else {
                throw new Error("Not in Telegram");
            }
        } catch (e) {
            console.warn("Running outside Telegram, using mock");
            tg = {
                ready: () => {},
                expand: () => {},
                HapticFeedback: { impactOccurred: () => {} },
                initData: ""
            };
        }

        const initData = tg.initData;
        const debugDiv = document.getElementById('debug');
        debugDiv.innerHTML = 'initData: ' + (initData ? initData.substring(0, 100) + '...' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è API-–∑–∞–ø—Ä–æ—Å–æ–≤ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        async function apiCall(endpoint, method = 'GET', body = null) {
            const headers = {
                'Content-Type': 'application/json'
            };
            if (initData) {
                headers['X-Telegram-Init-Data'] = initData;
            }
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);
            
            try {
                const url = `${API_BASE_URL}/api/${endpoint}`;
                console.log(`Fetching ${url}...`);
                const response = await fetch(url, options);
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                debugDiv.innerHTML += '<br>–û—à–∏–±–∫–∞: ' + error.message;
                showError(`API error (${endpoint}): ${error.message}`);
                return null;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let userData = null;
        async function loadUser() {
            userData = await apiCall('user');
            if (!userData) {
                showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API_BASE_URL –∏ CORS.");
                return;
            }
            document.getElementById('gold').textContent = userData.gold;
            document.getElementById('exp').textContent = userData.exp;
            updateInventoryDisplay(userData.inventory);
            
            if (userData.boss_progress) {
                checkBosses(userData.boss_progress);
            }
        }

        function updateInventoryDisplay(inv) {
            const invDiv = document.getElementById('inventory');
            const items = Object.entries(inv)
                .filter(([_, amt]) => amt > 0)
                .map(([res, amt]) => `${res}: ${amt}`);
            invDiv.textContent = items.join(', ') || '–ø—É—Å—Ç–æ';
        }

        let currentBossId = null;
        function checkBosses(bossProgress) {
            for (const [bossId, progress] of Object.entries(bossProgress)) {
                if (!progress.defeated) {
                    currentBossId = bossId;
                    document.getElementById('boss-health').style.display = 'block';
                    document.getElementById('boss-name').textContent = bossId;
                    loadBossInfo(bossId);
                    break;
                }
            }
        }

        async function loadBossInfo(bossId) {
            const data = await apiCall(`boss/${bossId}`);
            if (data) {
                updateBossHealth(data.current_health, data.max_health);
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ü–µ–Ω—ã Three.js
        try {
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111122);

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(5, 5, 10);

            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.maxPolarAngle = Math.PI / 2;

            // –û—Å–≤–µ—â–µ–Ω–∏–µ
            const ambientLight = new THREE.AmbientLight(0x404060);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(1, 2, 1);
            scene.add(dirLight);

            // –ü–æ–ª
            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.8, metalness: 0.2 });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = 0;
            scene.add(floor);

            // –†–µ—Å—É—Ä—Å—ã (–∫—É–±—ã)
            const resources = [];
            const positions = [
                [-3, 0.5, -3], [3, 0.5, -3], [0, 0.5, 3], [-2, 0.5, 2], [2, 0.5, 2],
                [-4, 0.5, 1], [4, 0.5, 1], [-1, 0.5, -4], [1, 0.5, -4]
            ];
            const colors = [0xffaa00, 0xcc8800, 0xaaaaaa, 0x44aa88, 0x8844aa, 0xaa44aa, 0x88aa44, 0xaa8844, 0x44aa44];
            positions.forEach((pos, i) => {
                const geometry = new THREE.BoxGeometry(1, 1, 1);
                const material = new THREE.MeshStandardMaterial({ color: colors[i], emissive: 0x222222 });
                const cube = new THREE.Mesh(geometry, material);
                cube.position.set(pos[0], pos[1], pos[2]);
                cube.userData = { type: 'resource', id: i % 5 };
                scene.add(cube);
                resources.push(cube);
            });

            // –ú–æ–¥–µ–ª—å –±–æ—Å—Å–∞ (–∫–æ–Ω—É—Å)
            const bossGeometry = new THREE.ConeGeometry(1, 2, 8);
            const bossMaterial = new THREE.MeshStandardMaterial({ color: 0xff3333, emissive: 0x440000 });
            const boss = new THREE.Mesh(bossGeometry, bossMaterial);
            boss.position.set(0, 1, 0);
            boss.userData = { type: 'boss' };
            scene.add(boss);
            boss.visible = false;

            // –†—ç–π–∫–∞—Å—Ç–µ—Ä –¥–ª—è –∫–ª–∏–∫–æ–≤
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();

            function onClick(event) {
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects([...resources, boss]);
                if (intersects.length > 0) {
                    const hit = intersects[0].object;
                    if (hit.userData.type === 'resource') {
                        hit.material.emissive.setHex(0x444444);
                        setTimeout(() => hit.material.emissive.setHex(0x222222), 100);
                        
                        apiCall('click', 'POST', { resourceId: hit.userData.id })
                            .then(data => {
                                if (data) {
                                    document.getElementById('gold').textContent = data.new_gold;
                                    document.getElementById('exp').textContent = data.new_exp;
                                    updateInventoryDisplay(data.inventory);
                                    if (tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
                                }
                            });
                    } else if (hit.userData.type === 'boss' && currentBossId) {
                        hit.material.emissive.setHex(0xaa0000);
                        setTimeout(() => hit.material.emissive.setHex(0x440000), 200);
                        
                        apiCall('boss/attack', 'POST', { boss_id: currentBossId })
                            .then(data => {
                                if (data) {
                                    if (data.defeated) {
                                        boss.visible = false;
                                        document.getElementById('boss-health').style.display = 'none';
                                    } else {
                                        updateBossHealth(data.current_health, data.max_health);
                                    }
                                    document.getElementById('gold').textContent = data.new_gold;
                                    document.getElementById('exp').textContent = data.new_exp;
                                    updateInventoryDisplay(data.inventory);
                                    if (tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('heavy');
                                }
                            });
                    }
                }
            }

            window.addEventListener('click', onClick);

            function updateBossHealth(current, max) {
                document.getElementById('boss-current-health').textContent = current;
                document.getElementById('boss-max-health').textContent = max;
                const percent = (current / max) * 100;
                document.getElementById('boss-health-fill').style.width = percent + '%';
                
                if (current > 0) {
                    boss.visible = true;
                } else {
                    boss.visible = false;
                }
            }

            // –ê–Ω–∏–º–∞—Ü–∏—è
            function animate() {
                requestAnimationFrame(animate);
                resources.forEach(cube => {
                    cube.rotation.y += 0.005;
                });
                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            loadUser();

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Å–∞–π–∑–∞
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

        } catch (e) {
            showError("Three.js error: " + e.message);
        }
    </script>
</body>
</html>


