<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–µ—Å—Ç –≤–∏–¥–∏–º–æ—Å—Ç–∏ - –∫—É–± –≤–º–µ—Å—Ç–æ –º–æ–¥–µ–ª–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        #hud, #boss-health {
            position: absolute;
            color: white;
            background: rgba(20,20,30,0.85);
            padding: 10px;
            border-radius: 8px;
            z-index: 200;
            pointer-events: none;
        }
        #hud { top: 10px; left: 10px; }
        #boss-health { top: 10px; right: 10px; width: 220px; display: none; }
        #debug-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: black;
            color: #0f0;
            padding: 10px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 12px;
            max-height: 200px;
            overflow: auto;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js"
            }
        }
    </script>
</head>
<body>
    <div id="hud">
        <span>üí∞ <span id="gold">0</span> ‚ú® <span id="exp">0</span></span><br>
        –£—Ä–æ–≤–µ–Ω—å <span id="level">1</span>
    </div>
    <div id="boss-health">
        <span id="boss-name"></span> <span id="boss-current-health">0</span>/<span id="boss-max-health">0</span>
    </div>
    <div id="debug-info"></div>

    <script type="module">
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const API_BASE_URL = 'https://telegram-clicker-bot-zi6c.onrender.com';
        const BOSS_IDS = ['goblin_king', 'dragon_lair', 'lich_castle'];
        const BOSS_NAMES = {
            'goblin_king': '–ö–æ—Ä–æ–ª—å –≥–æ–±–ª–∏–Ω–æ–≤',
            'dragon_lair': '–û–≥–Ω–µ–Ω–Ω—ã–π –¥—Ä–∞–∫–æ–Ω',
            'lich_castle': '–ê—Ä—Ö–∏–ª–∏—á'
        };

        let currentBossIndex = 0;
        let currentBossId = BOSS_IDS[0];
        let scene, camera, renderer, controls;
        let THREE;

        const debugInfo = document.getElementById('debug-info');
        function debugLog(msg) {
            debugInfo.innerHTML += new Date().toLocaleTimeString() + ': ' + msg + '<br>';
            console.log(msg);
        }

        // --- –¢–ï–õ–ï–ì–†–ê–ú –ò API ---
        let tg;
        try {
            tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
        } catch (e) {
            tg = { initData: '' };
        }
        const initData = tg.initData;
        debugLog('initData: ' + (initData ? initData.substring(0,50) + '...' : '–Ω–µ—Ç'));

        async function apiCall(endpoint) {
            const headers = { 'Content-Type': 'application/json' };
            if (initData) headers['X-Telegram-Init-Data'] = initData;
            try {
                const res = await fetch(`${API_BASE_URL}/api/${endpoint}`, { headers });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            } catch (e) {
                debugLog(`–û—à–∏–±–∫–∞ API: ${e.message}`);
                return null;
            }
        }

        // --- –ó–ê–ì–†–£–ó–ö–ê –ë–û–°–°–ê –î–õ–Ø HUD ---
        async function loadBossInfo(bid) {
            debugLog(`loadBossInfo for ${bid}`);
            const data = await apiCall(`boss/${bid}`);
            if (data) {
                document.getElementById('boss-name').textContent = BOSS_NAMES[bid] || bid;
                document.getElementById('boss-current-health').textContent = data.current_health;
                document.getElementById('boss-max-health').textContent = data.max_health;
                document.getElementById('boss-health').style.display = 'block';
            }
        }

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø 3D ---
        async function init3D() {
            debugLog('init3D started');
            const THREE_IMPORT = await import('three');
            THREE = THREE_IMPORT;
            const { OrbitControls } = await import('https://unpkg.com/three@0.128.0/examples/jsm/controls/OrbitControls.js');

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111122);

            camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
            camera.position.set(5, 4, 8);
            camera.lookAt(0, 3, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(innerWidth, innerHeight);
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.set(0, 3, 0);

            // –û—Å–≤–µ—â–µ–Ω–∏–µ
            const ambient = new THREE.AmbientLight(0x606080);
            scene.add(ambient);
            const light1 = new THREE.DirectionalLight(0xffffff, 1.2);
            light1.position.set(5, 10, 7);
            scene.add(light1);
            const light2 = new THREE.DirectionalLight(0xffaa88, 0.8);
            light2.position.set(-5, 5, -5);
            scene.add(light2);

            // –ü–æ–ª-—Å–µ—Ç–∫–∞
            const gridHelper = new THREE.GridHelper(10, 10, 0xaaaaaa, 0x444444);
            scene.add(gridHelper);

            // –û—Å–∏
            const axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);

            // –¢–ï–°–¢–û–í–´–ô –ö–†–ê–°–ù–´–ô –ö–£–ë (–∫–∞–∫ –æ—Ä–∏–µ–Ω—Ç–∏—Ä)
            const testCube = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color: 0xff0000, emissive: 0x330000}));
            testCube.position.set(0, 4, 0);
            scene.add(testCube);
            debugLog('–ö—Ä–∞—Å–Ω—ã–π –∫—É–± –Ω–∞ –≤—ã—Å–æ—Ç–µ 4');

            // –í–º–µ—Å—Ç–æ —Å–ª–æ–∂–Ω–æ–π –º–æ–¥–µ–ª–∏ –±–æ—Å—Å–∞ - –ø—Ä–æ—Å—Ç–æ–π —è—Ä–∫–∏–π –∫—É–± –Ω–∞ –≤—ã—Å–æ—Ç–µ ~3.5
            const bossCube = new THREE.Mesh(new THREE.BoxGeometry(2,2,2), new THREE.MeshStandardMaterial({color: 0x00ff00, emissive: 0x224400}));
            bossCube.position.set(0, 3.5, 0);
            scene.add(bossCube);
            debugLog('–ó–µ–ª—ë–Ω—ã–π –∫—É–± –Ω–∞ –≤—ã—Å–æ—Ç–µ 3.5');

            // –ê–Ω–∏–º–∞—Ü–∏—è
            function animate() {
                testCube.rotation.y += 0.01;
                bossCube.rotation.y += 0.01;
                controls.update();
                renderer.render(scene, camera);
                requestAnimationFrame(animate);
            }
            animate();

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Å—Å–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ HUD
            loadBossInfo('goblin_king');
        }

        init3D();
    </script>
</body>
</html>
